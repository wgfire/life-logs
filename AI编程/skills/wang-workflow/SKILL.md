---
name: wang-workflow
description: 智能编程工作流，通过5个协作Agent（需求分析、需求评审、任务规划、任务实现、任务Review）将模糊需求转化为高质量代码。支持全流程执行或跳过需求阶段直接进入任务规划。
license: MIT
metadata:
  version: 1.0.0
  model: claude-opus-4-5-20251101
---

# Wang Workflow - 智能编程工作流

通过 5 个协作 Agent 将模糊需求转化为高质量代码的智能编程流程。

---

## 快速开始

```bash
# 完整流程：需求分析 → 需求评审 → 任务规划 → 任务实现 → 任务Review
/wang 实现一个用户登录功能

# 跳过需求阶段，直接进入任务规划（适用于已明确的任务）
/wang --task 给 Button 组件添加 loading 状态
```

---

## 触发方式

| 命令 | 说明 |
|------|------|
| `/wang {需求描述}` | 完整 5 阶段流程 |
| `/wang --task {任务描述}` | 跳过需求分析和评审，直接从任务规划开始 |
| `帮我用 wang 流程实现...` | 自然语言触发 |
| `走一遍完整的编程流程` | 自然语言触发 |

---

## 流程概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    /wang {需求描述}                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Phase 1: 需求分析 Agent                                          │
│ • 解析用户原始需求                                                │
│ • 挖掘隐含需求和深层意图                                          │
│ • 提炼核心功能点                                                  │
│ • 输出：结构化需求文档                                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Phase 2: 需求评审 Agent                                          │
│ • 结合项目定位评估需求合理性                                       │
│ • 识别不合理或模糊的需求                                          │
│ • 扩展和细化可实现的需求                                          │
│ • 输出：评审后的高质量需求                                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Phase 3: 任务规划 Agent                                          │
│ • 读取项目结构和现有代码                                          │
│ • 将需求拆解为具体任务                                            │
│ • 确定任务优先级和依赖关系                                        │
│ • 输出：可执行的任务列表                                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Phase 4: 任务实现 Agent                                          │
│ • 按任务列表逐个实现                                              │
│ • 遵循 KISS/YAGNI/SOLID 原则                                     │
│ • 编写高质量代码                                                  │
│ • 输出：完成的代码变更                                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ Phase 5: 任务 Review Agent                                       │
│ • 对照需求检查完成度                                              │
│ • 验证代码质量和功能正确性                                        │
│ • 完成度 < 100%？→ 返回 Phase 4 继续实现                          │
│ • 完成度 = 100%？→ 流程结束                                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌────────┴────────┐
                    │                 │
              完成度 < 100%      完成度 = 100%
                    │                 │
                    ▼                 ▼
              返回 Phase 4         流程完成
```

---

## 各阶段详解

### Phase 1: 需求分析 Agent

**职责**：将用户的模糊描述转化为结构化需求

**输入**：用户原始需求描述

**处理流程**：
1. 解析用户描述，识别关键词和意图
2. 应用 5W1H 分析法挖掘隐含需求
3. 区分功能性需求和非功能性需求
4. 提炼核心功能点，排除噪音

**输出格式**：
```markdown
## 需求分析报告

### 原始需求
{用户原始描述}

### 核心意图
{一句话概括用户真正想要的}

### 功能需求
1. {功能点1}
2. {功能点2}
...

### 非功能需求
- 性能：{如有}
- 安全：{如有}
- 兼容：{如有}

### 隐含需求
- {通过分析发现的未明说需求}

### 边界条件
- {明确什么不在范围内}
```

---

### Phase 2: 需求评审 Agent

**职责**：确保需求的合理性和可实现性

**输入**：Phase 1 的需求分析报告 + 项目上下文

**处理流程**：
1. 读取项目 CLAUDE.md 获取项目定位和约束
2. 评估每个需求是否符合项目目标
3. 识别技术风险和实现难点
4. 细化模糊需求，拆分过大需求
5. 标记并说明不合理的需求

**评审维度**：
| 维度 | 检查点 |
|------|--------|
| 合理性 | 是否符合项目定位？是否过度工程化？ |
| 可行性 | 技术上能否实现？依赖是否满足？ |
| 完整性 | 是否有遗漏的边界情况？ |
| 清晰性 | 描述是否明确无歧义？ |

**输出格式**：
```markdown
## 需求评审报告

### 评审通过的需求
1. {需求1} - 可直接实现
2. {需求2} - 可直接实现

### 需要细化的需求
1. {原需求} → {细化后的需求列表}

### 不合理的需求（已移除）
1. {需求} - 原因：{为什么不合理}

### 风险提示
- {潜在的技术风险}

### 最终需求清单
1. {确认的需求1}
2. {确认的需求2}
...
```

---

### Phase 3: 任务规划 Agent

**职责**：将需求转化为可执行的任务列表

**输入**：Phase 2 的评审后需求 + 项目代码库

**处理流程**：
1. 探索项目结构，理解现有架构
2. 识别需要修改/新增的文件
3. 将每个需求拆解为原子任务
4. 分析任务间的依赖关系
5. 确定执行顺序

**任务拆分原则**：
- 每个任务应在 30 分钟内可完成
- 每个任务有明确的完成标准
- 任务之间依赖关系清晰

**输出格式**：
```markdown
## 任务规划

### 涉及文件
- {文件路径1} - {修改/新增}
- {文件路径2} - {修改/新增}

### 任务列表
| # | 任务 | 依赖 | 完成标准 |
|---|------|------|----------|
| 1 | {任务描述} | - | {如何判断完成} |
| 2 | {任务描述} | 1 | {如何判断完成} |
| 3 | {任务描述} | 1,2 | {如何判断完成} |

### 执行顺序
1 → 2 → 3 → ...
```

---

### Phase 4: 任务实现 Agent

**职责**：高质量地完成每个任务

**输入**：Phase 3 的任务列表

**处理流程**：
1. 按顺序执行每个任务
2. 实现前先阅读相关代码
3. 遵循项目编码规范
4. 应用 KISS/YAGNI/SOLID 原则
5. 使用 TodoWrite 追踪进度

**编码原则**：
- 最简实现优先，不做过度设计
- 不添加当前不需要的功能
- 单一职责，每个函数只做一件事
- 使用项目现有的模式和风格

**输出**：完成的代码变更（通过 Edit/Write 工具）

---

### Phase 5: 任务 Review Agent

**职责**：验证实现是否满足需求

**输入**：Phase 2 的需求清单 + Phase 4 的代码变更

**处理流程**：
1. 逐条对照需求检查实现
2. 验证代码质量（可读性、健壮性）
3. 检查是否引入新问题
4. 计算完成度百分比

**完成度评估**：
```markdown
## Review 报告

### 需求完成度
| 需求 | 状态 | 说明 |
|------|------|------|
| {需求1} | ✅ 完成 | - |
| {需求2} | ⚠️ 部分完成 | {缺少什么} |
| {需求3} | ❌ 未完成 | {原因} |

### 总完成度：{X}%

### 代码质量检查
- [ ] 符合 KISS 原则
- [ ] 符合 YAGNI 原则
- [ ] 符合 SOLID 原则
- [ ] 无明显 bug
- [ ] 代码可读性良好

### 需要补充实现
1. {待完成项1}
2. {待完成项2}
```

**决策逻辑**：
- 完成度 = 100% 且质量检查全通过 → 流程结束
- 完成度 < 100% 或质量问题 → 返回 Phase 4，附带待完成清单
- 最多循环 3 次，超过则暂停并询问用户

---

## 配置项

| 配置 | 默认值 | 说明 |
|------|--------|------|
| `max_review_loops` | 3 | Review 不通过时最大重试次数 |
| `completion_threshold` | 100% | 完成度阈值 |
| `skip_phases` | [] | 跳过的阶段（--task 时为 [1,2]） |

---

## 模型配置

每个 Agent 可以指定不同的模型，以平衡能力和成本：

| Agent | 推荐模型 | 原因 |
|-------|----------|------|
| 需求分析 Agent | `sonnet` | 语义理解任务，sonnet 足够 |
| 需求评审 Agent | `sonnet` | 评审判断任务，sonnet 足够 |
| 任务规划 Agent | `opus` | 需要深度理解代码库和架构 |
| 任务实现 Agent | `opus` | 核心编码任务，需要最强能力 |
| 任务 Review Agent | `sonnet` | 对照检查任务，sonnet 足够 |

### 模型选项

| 模型 | 特点 | 成本 |
|------|------|------|
| `opus` | 最强推理和编码能力 | 高 |
| `sonnet` | 平衡的性能和成本 | 中 |
| `haiku` | 快速响应，适合简单任务 | 低 |

### 自定义模型配置

在触发时可以覆盖默认模型配置：

```
/wang --models="分析:sonnet,评审:sonnet,规划:opus,实现:opus,review:sonnet" 实现用户登录功能
```

或使用预设配置：

```
/wang --preset=fast    # 全部使用 sonnet（快速但能力稍弱）
/wang --preset=quality # 全部使用 opus（最高质量但成本高）
/wang --preset=balanced # 默认配置（推荐）
```

---

## 使用示例

### 示例 1：完整流程

```
用户：/wang 给编辑器添加撤销/重做功能

Phase 1 输出：
- 核心需求：实现 undo/redo 操作栈
- 功能点：撤销按钮、重做按钮、快捷键支持

Phase 2 输出：
- 确认需求合理
- 细化：需要限制历史记录数量（避免内存问题）

Phase 3 输出：
- 任务1：创建 history store
- 任务2：实现 undo 方法
- 任务3：实现 redo 方法
- 任务4：添加工具栏按钮
- 任务5：绑定快捷键

Phase 4：逐个实现任务

Phase 5：验证完成度 100%，流程结束
```

### 示例 2：跳过需求阶段

```
用户：/wang --task 修复 Button 组件的 hover 样式问题

直接进入 Phase 3：
- 任务1：定位 Button 组件样式文件
- 任务2：修复 hover 状态样式

Phase 4：实现修复

Phase 5：验证完成，流程结束
```

---

## 反模式

| 避免 | 原因 | 正确做法 |
|------|------|----------|
| 跳过需求分析直接编码 | 可能实现错误的功能 | 至少做简单的需求确认 |
| 任务拆分过细 | 增加管理开销 | 保持任务粒度适中 |
| Review 标准模糊 | 导致无限循环 | 明确可量化的完成标准 |
| 忽略项目约束 | 产出不符合项目风格 | 始终参考 CLAUDE.md |

---

## 与项目原则的一致性

本 skill 严格遵循项目 CLAUDE.md 中的设计原则：

- **KISS**：每个 Agent 职责单一，流程线性清晰
- **YAGNI**：只实现当前需要的功能，不预设扩展
- **SOLID**：Agent 间通过明确的输入输出解耦

---

## 扩展点

1. **新增 Agent**：可在任意阶段间插入新的 Agent（如安全审查 Agent）
2. **自定义评审维度**：扩展 Phase 2 的评审检查点
3. **集成测试**：在 Phase 5 中加入自动化测试验证
4. **并行任务**：改进 Phase 4 支持无依赖任务并行执行

---

## 验证清单

使用此 skill 后，确认：

- [ ] 需求被充分理解和记录
- [ ] 任务列表完整且有序
- [ ] 代码变更符合项目规范
- [ ] 所有需求点都有对应实现
- [ ] Review 通过且完成度达标
